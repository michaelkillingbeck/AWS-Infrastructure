version: 0.2

phases:
  build:
    commands:
      - 'INTEGRATION_SERVER_IP_ADDRESS=$(
            aws ssm get-parameter 
            --name "/General/IntegrationServer/IPAddress" 
            --query "Parameter.Value" 
            --output text)'
      - ls
      - >
        echo 
        $(jq 
          --arg INTEGRATION_SERVER_IP_ADDRESS "$INTEGRATION_SERVER_IP_ADDRESS" 
          '.Changes[0].ResourceRecordSet.ResourceRecords[0].Value = $INTEGRATION_SERVER_IP_ADDRESS' 
          ics-integration-hosted-zone-record.json
        ) > ics-integration-hosted-zone-record.json
      - >
        hostedZoneID=
          $(aws route53 list-hosted-zones-by-name | 
            jq 
              --arg name "integration.michaelkillingbeck.com." 
              -r '.HostedZones 
              | .[] 
              | select(.Name=="\($name)") 
              | .Id'
          )
      - aws route53 change-resource-record-sets
        --hosted-zone-id $hostedZoneID
        --change-batch file://ics-integration-hosted-zone-record.json