version: 0.2

env:
  parameter-store:
    INTEGRATION_SERVER_IP_ADDRESS: /General/IntegrationServer/IPAddress

phases:
  build:
    commands:
      - echo INTEGRATION_SERVER_IP_ADDRESS
      - echo $INTEGRATION_SERVER_IP_ADDRESS
      - echo $(jq --arg output "$INTEGRATION_SERVER_IP_ADDRESS" '.Changes[0].ResourceRecordSet.ResourceRecords[0].Value = $INTEGRATION_SERVER_IP_ADDRESS' ics-integration-hosted-zone-record.json) > ics-integration-hosted-zone-record.json
      - hostedZoneID=$(aws route53 list-hosted-zones-by-name |  jq --arg name "integration.michaelkillingbeck.com." -r '.HostedZones | .[] | select(.Name=="\($name)") | .Id')
      - aws route53 change-resource-record-sets
        --hosted-zone-id $hostedZoneID
        --change-batch file://ics-integration-hosted-zone-record.json